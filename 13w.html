<html>
  <head>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <title>Chinese Poker</title>
    <style>
h1 {
  color: brown;
  font-size: 40px;
}
div.logo {
  color: aqua;
  font-size: 30px;
  font-weight: bold;
  text-align: center;
  text-shadow: 3px 3px 2px black;
}
div.score {
  color: white;
  font-size: 30px;
  font-weight: bold;
  text-align: center;
}
table.table {
  background: darkgreen;
  border-radius: 0px;
  padding: 5px 5px;
  position: relative;
}
button, select {
  border: none;
  opacity: 0.8;
  font-size: 20px;
  padding: 5px 5px;
  width: 80px;
}
button.move {
  font-size: 30px;
  padding: 0px 0px;
  width: 60px;
}
button.load {
  font-size: 20px;
  padding: 5px 0px;
  width: 40px;
}
select.menu {
  font-size: 20px;
  padding: 5px 0px;
  width: 80px;
}
button:hover, select:hover {
  background: white;
  opacity: 0.9;
}
tr.move {
  text-align: center;
}
tr.menu, td.menu, tr.pattern {
  color: white;
  font-size: 20px;
  text-align: center;
}
table.hand {
  background-color: darkgreen;
  border-radius: 5px;
  margin: auto;
  padding: 2px;
}
table.card {
  background-color: white;
  border-radius: 5px;
  padding: 0px;
  text-align: center;
  width: 60px;
}
td.rank {
  font-size: 30px;
}
td.suit {
  font-size: 25px;
}
div.alert {
  background: darkgreen;
  color: azure;
  display: none;
  font-size: 30px;
  height: 100%;
  left: 0;
  margin: auto;
  opacity: 0.9;
  position: absolute;
  text-align: center;
  top: 0;
  width: 100%;
  z-index: 1;
}
div.special {
  bottom: 18%;
  color: gold;
  display: none;
  font-size: 80px;
  font-style: italic;
  font-weight: bold;
  left: 0;
  opacity: 0.9;
  position: absolute;
  text-align: center;
  text-shadow: 3px 3px 2px grey;
  width: 90%;
}
    </style>
    <script>
var suit_names = [
  '<font color="black">♠</font>',
  '<font color="red">♥</font>',
  '<font color="black">♣</font>',
  '<font color="red">♦</font>',
];
var rank_names = [
  '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A' ];
var Two = 0, Three = 1, Four = 2, Five = 3, Six = 4, Seven = 5, Eight = 6,
    Nine = 7, Ten = 8, Jack = 9, Queen = 10, King = 11, Ace = 12;

var pattern_names = [
  'junk', 'pair', 'two pairs', 'triple', 'straight', 'flush',
  'full house', 'quadruple', 'straight flush', 'royal flush'
];
var Junk = 0, Pair = 1, TwoPairs = 2, Triple = 3, Straight = 4, Flush = 5,
    FullHouse = 6, Quadruple = 7, StraightFlush = 8, RoyalFlush = 9;
var pattern_points = [
  //        Tr       FH Qu SF  RF
  [1, 1, 1, 3, 1, 1, 1, 1,  1,  1],  // front
  [1, 1, 1, 1, 1, 1, 2, 8, 10, 20],  // center
  [1, 1, 1, 1, 1, 1, 1, 4,  5, 10],  // back
];

var special_names = [
  '', 'Six Pairs', 'Three Flushes', 'Three Straights', 'Dragon'
];
var None = 0, SixPairs = 1, ThreeFlushes = 2, ThreeStraights = 3, Dragon = 4;
var special_points = [0, 3, 3, 3, 13];

var wave_names = [ 'front', 'center', 'back' ];
var Front = 0, Center = 1, Back = 2;

var ai_handicap = 0;
var ai_total_points = 0, total_points = 0;
var ai_hand = [], hand = [];
var sorted_by_rank = false;
var wave_sizes = [ 3, 5, 5 ];
var wave_values = [ 0, 0, 0 ];
var waves = [ [], [], [] ];
var membership = {};
var active_wave = Front;
var saved_waves = [];

function suit(card) { return Math.floor(card / 13); }
function rank(card) { return card % 13; }

function deal_hand() {
  var deck = [];
  for (var i = 0; i < 52; ++i) {
    deck.push(i);
  }
  for (var i = 0; i < 52; ++i) {
    var pos = Math.floor(Math.random() * (52 - i));
    var card = deck[pos];
    deck[pos] = deck[51 - i];
    deck[51 - i] = card;
  }

  ai_hand = deck.slice(0, 13);
  for (var wave in wave_names) {
    for (var i = 0; i < wave_sizes[wave]; ++i) {
      clear_card('ai_' + wave_names[wave] + '_', i);
    }
  }
  select_level();

  hand = deck.slice(13, 26);
  sort_hand(false);
  membership = {};
  for (var wave in waves) {
    waves[wave] = [];
    redraw_wave(wave);
  }
  redraw_hand();
  saved_waves = [];
  set_inner_html('load', '&nbsp;Load: ');
  hide_element('deal');
  show_element('show');
  hide_element('load');
  hide_element('special');
  enable_element('claim');
}

function sort_hand(toggle) {
  if (toggle) sorted_by_rank = !sorted_by_rank;
  if (sorted_by_rank) {
    hand.sort(function(a, b) { return rank(a) - rank(b); });
  } else {
    hand.sort(function(a, b) {
      return suit(a) == suit(b) ? rank(a) - rank(b) : suit(a) - suit(b);
    });
  }
  redraw_hand();
}

function redraw_hand() {
  for (var card in hand) {
    set_card('', card, hand[card]);
    if (membership[hand[card]] == null) {
      enable_card('', card);
    } else {
      disable_card('', card);
    }
  }
}

function activate_wave(wave) {
  set_background(wave_names[active_wave], 'darkgreen');
  set_background(wave_names[wave], 'orange');
  active_wave = wave;
}

function move_card(index) {
  var card = hand[index];
  if (membership[card] != null) {
    var wave = membership[card];
    for (var i in waves[wave]) {
      if (waves[wave][i] == card) {
        undo_card(membership[card], i);
        break;
      }
    }
    return;
  }

  disable_card('', index);
  membership[card] = active_wave;
  waves[active_wave].push(card);
  waves[active_wave].sort(function(a, b) { return rank(a) - rank(b); });
  redraw_wave(active_wave);

  if (waves[active_wave].length == wave_sizes[active_wave]) {
    for (var wave in waves) {
      if (waves[wave].length < wave_sizes[wave]) {
        activate_wave(wave);
        break;
      }
    }
  }
}

function fill_wave(wave) {
  activate_wave(wave);
  for (var i = waves[wave].length; i < wave_sizes[wave]; ++i) {
    for (var index in hand) {
      if (membership[hand[index]] == null) {
        move_card(index);
        break;
      }
    }
  }
}

function move_all_cards() {
  for (var index in hand) {
    move_card(i);
  }
}

function undo_all_cards() {
  for (var wave in waves) {
    clear_wave(wave);
  }
}

function clear_wave(wave) {
  for (var i = waves[wave].length - 1; i >= 0; --i) {
    undo_card(wave, i);
  }
  redraw_wave(wave);
}

function undo_card(wave, index) {
  if (waves[wave].length <= index) {
    redraw_wave(wave);
    return;
  }

  for (var card in hand) {
    if (hand[card] == waves[wave][index]) {
      enable_card('', card);
      delete membership[hand[card]];
      break;
    }
  }
  waves[wave].splice(index, 1);
  redraw_wave(wave);
}

function redraw_wave(wave) {
  var name = wave_names[wave];
  if (waves[wave].length < wave_sizes[wave]) {
    set_inner_html(name + '_pattern', '&nbsp;');
    wave_values[wave] = 0;
  } else {
    var eval = new WaveEvaluator(waves[wave], wave);
    set_inner_html(name + '_pattern',
                   pattern_names[eval.pattern] + ': ' + eval.value + '%');
    wave_values[wave] = eval.value;
    // The wave could be resorted.
    waves[wave] = eval.wave;
  }
  var sum = wave_values.reduce((a, b) => a + b, 0);
  set_inner_html('average', sum ? Math.floor(sum / 3) + '%' : '');

  for (var i = 0; i < wave_sizes[wave]; ++i) {
    if (i < waves[wave].length)
      set_card(name + '_', i, waves[wave][i]);
    else
      clear_card(name + '_', i);
  }
  activate_wave(wave);
}

function set_card(prefix, index, card) {
  set_inner_html(prefix + 'suit_' + index, suit_names[suit(card)]);
  set_inner_html(prefix + 'rank_' + index, rank_names[rank(card)]);
}

function clear_card(prefix, index) {
  set_inner_html(prefix + 'suit_' + index, '?');
  set_inner_html(prefix + 'rank_' + index, '?');
}

function enable_card(prefix, index) {
  var id = prefix + 'card_' + index;
  set_background(id, 'white');
}

function disable_card(prefix, index) {
  var id = prefix + 'card_' + index;
  set_background(id, 'silver');
}

function set_inner_html(id, value) {
  document.getElementById(id).innerHTML = value;
}

function set_background(id, color) {
  document.getElementById(id).style.backgroundColor = color;
}

function show_element(id) {
  document.getElementById(id).style.display = 'inline';
}

function hide_element(id) {
  document.getElementById(id).style.display = 'none';
}

function enable_element(id) {
  document.getElementById(id).disabled = false;
}

function disable_element(id) {
  document.getElementById(id).disabled = true;
}

function show_alert(message) {
  set_inner_html('alert_message', message);
  show_element('alert');
}

function save_waves() {
  for (var wave in waves) {
    if (waves[wave].length < wave_sizes[wave]) {
      show_alert('Finish all three waves before saving them.');
      return;
    }
  }
  for (var number in saved_waves) {
    var duplicate = true;
    for (var card in membership) {
      if (membership[card] != saved_waves[number][card]) {
        duplicate = false;
        break;
      }
    }
    if (duplicate) {
      show_alert('Waves already saved as #' + (Number(number) + 1));
      return;
    }
  }
  var number = saved_waves.length;
  saved_waves.push({});
  for (var card in membership) {
    saved_waves[number][card] = membership[card];
  }

  var button = document.createElement('BUTTON');
  button.innerHTML = Math.floor(number + 1);
  button.className = 'load';
  button.onclick = function() { load_waves(number) };
  document.getElementById('load').appendChild(button);
  show_element('load');
}

function load_waves(number) {
  for (var wave in waves) {
    waves[wave] = [];
  }
  for (var card in saved_waves[number]) {
    membership[card] = saved_waves[number][card];
    waves[membership[card]].push(card);
  }
  for (var wave in waves) {
    redraw_wave(wave);
  }
  redraw_hand();
}

function select_level() {
  ai_handicap = document.getElementById('handicap').value;
}

function show_hand() {
  for (var wave in waves) {
    if (waves[wave].length < wave_sizes[wave]) {
      show_alert('Finish all three waves before matching against AI.');
      return;
    }
  }

  var eval = [new WaveEvaluator(waves[Front], Front),
              new WaveEvaluator(waves[Center], Center),
              new WaveEvaluator(waves[Back], Back)];
  if (eval[Center].is_smaller_than(eval[Front])) {
    show_alert('The center wave should not be smaller than the front wave.');
    return;
  }
  if (eval[Back].is_smaller_than(eval[Center])) {
    show_alert('The back wave should not be smaller than the center wave.');
    return;
  }

  var ai_waves = (new HandOptimizer(ai_hand, ai_handicap)).waves;
  var ai_eval = [new WaveEvaluator(ai_waves[Front], Front),
                 new WaveEvaluator(ai_waves[Center], Center),
                 new WaveEvaluator(ai_waves[Back], Back)];
  var points = 0, ai_points = 0;
  var wins = 0, ai_wins = 0;
  for (var wave in ai_waves) {
    for (var card in ai_waves[wave]) {
      set_card('ai_' + wave_names[wave] + '_', card, ai_waves[wave][card]);
    }
    var result = '';
    if (ai_eval[wave].is_smaller_than(eval[wave])) {
      var p = pattern_points[wave][eval[wave].pattern];
      points += p;
      result = '+' + p;
      ++wins;
    } else if (eval[wave].is_smaller_than(ai_eval[wave])) {
      var p = pattern_points[wave][ai_eval[wave].pattern];
      ai_points += p;
      result = '-' + p;
      ++ai_wins;
    } else {
      result = '0';
    }
    set_inner_html(wave_names[wave] + '_pattern', result);
  }

  // Double points for a sweeping win.
  if (wins == 3) points *= 2;
  else if (ai_wins == 3) ai_points *= 2;
  set_inner_html('average', (wins == 3 || ai_wins == 3) ? 'x2' : 'x1');

  update_scores(points, ai_points);

  show_element('deal');
  hide_element('show');
}

function update_scores(points, ai_points) {
  total_points += points;
  ai_total_points += ai_points;
  set_inner_html('score', 'You ' + total_points + '-' + ai_total_points + ' AI');
}

class SpecialPattern {
  constructor(hand) {
    var hand_copy = hand.slice(0);

    if (this.dragon(hand_copy)) this.special = Dragon;
    else if (this.six_pairs(hand_copy)) this.special = SixPairs;
    else if (this.three_flushes(hand_copy)) this.special = ThreeFlushes;
    else if (this.three_straights(hand_copy)) this.special = ThreeStraights;
    else this.special = None;

    this.hand = hand_copy;
  }

  get pattern() { return this.special; }
  get cards() { return this.hand; }

  six_pairs(hand) {
    hand.sort(function(a, b) { return rank(a) - rank(b); });
    var num_pairs = 0;
    for (var i = 0; i < 12; ++i) {
      if (rank(hand[i]) == rank(hand[i + 1])) {
        ++num_pairs;
        i += 1;
      }
    }
    return num_pairs == 6;
  }

  is_flush(cards) {
    for (var i = 0; i < cards.length - 1; ++i)
      if (suit(cards[i]) != suit(cards[i + 1])) return false;
    return true;
  }

  three_flushes(hand) {
    hand.sort(function(a, b) { return suit(a) - suit(b); });
    if (this.is_flush(hand.slice(0,3)) && this.is_flush(hand.slice(3,8)) &&
        this.is_flush(hand.slice(8,13)))
      return true;
    if (this.is_flush(hand.slice(0,5)) && this.is_flush(hand.slice(5,8)) &&
        this.is_flush(hand.slice(8,13)))
      return true;
    if (this.is_flush(hand.slice(0,5)) && this.is_flush(hand.slice(5,10)) &&
        this.is_flush(hand.slice(10,13)))
      return true;
    return false;
  }

  is_straight(cards) {
    for (var i = 0; i < cards.length - 1; ++i)
      if (rank(cards[i]) + 1 != rank(cards[i + 1])) return false;
    return true;
  }

  dragon(hand) {
    hand.sort(function(a, b) { return rank(a) - rank(b); });
    return this.is_straight(hand);
  }

  remove_straight(histogram, length) {
    for (var i = 0; i < histogram.length; ++i)
      if (histogram[i] != 0) break;
    for (var j = 1; j < length; ++j)
      if (histogram[i + j] == 0) return false;
    for (var j = 0; j < length; ++j)
      --histogram[i + j];
    return true;
  }

  three_straights_with_histogram(histogram) {
    var h = histogram.slice(0);
    if (this.remove_straight(h, 3) && this.remove_straight(h, 5) &&
        this.remove_straight(h, 5))
      return true;
    var h = histogram.slice(0);
    if (this.remove_straight(h, 5) && this.remove_straight(h, 3) &&
        this.remove_straight(h, 5))
      return true;
    var h = histogram.slice(0);
    if (this.remove_straight(h, 5) && this.remove_straight(h, 5) &&
        this.remove_straight(h, 3))
      return true;
    return false;
  }

  three_straights(hand) {
    hand.sort(function(a, b) { return rank(a) - rank(b); });
    var histogram = new Array(13).fill(0);
    for (var card of hand) ++histogram[rank(card)];
    if (this.three_straights_with_histogram(histogram)) return true;

    var num_aces = histogram[Ace];
    if (num_aces == 0) return false;

    // Shift the histogram to the right and convert Aces to Ones.
    histogram.unshift(0);
    for (var i = 0; i < num_aces; ++i) {
      --histogram[Ace + 1];
      ++histogram[0];
      if (this.three_straights_with_histogram(histogram)) return true;
    }
    return false;
  }
};

function claim() {
  var special = new SpecialPattern(hand);
  if (special.pattern == None) {
    show_alert('No six pairs, three straights, three flushes or dragon.');
    return;
  }

  show_element('deal');
  hide_element('show');
  disable_element('claim');
  show_element('special');
  set_inner_html('special', special_names[special.pattern]);
  update_scores(special_points[special.pattern], 0);

  hand = special.cards;
  redraw_hand();
}

var junk_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  1,  1,  2,  2,  4,  7, 15, 34],
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1],
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]
];

var junk_value0 = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0, 20, 20, 21, 21, 22, 23, 24, 26, 30, 34, 42,  0],  //A?
  [ 0,  9,  9, 10, 10, 11, 11, 12, 13, 15, 18,  0,  0],  //K?
  [ 0,  5,  5,  5,  6,  6,  7,  7,  8,  8,  0,  0,  0]   //Q?
];

var one_pair_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [45, 47, 49, 51, 53, 56, 60, 64, 68, 73, 81, 89, 97],
  [ 2,  3,  3,  4,  5,  6,  8, 10, 12, 15, 18, 24, 33],
  [ 0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  2,  2,  3]
];

var one_pair_value0 = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [96, 96, 96, 96, 96, 96, 97, 97, 97, 97, 98, 98,  0],  //A?
  [86, 86, 86, 86, 86, 87, 87, 88, 89, 89, 90,  0, 91],  //K?
  [76, 76, 77, 77, 77, 78, 78, 78, 79, 80,  0, 82, 83]   //Q?
];

var one_pair_value1 = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0, 30, 31, 31, 32, 32, 33, 33, 34, 35, 36,  0],  //A?
  [ 0,  0, 23, 23, 23, 23, 23, 24, 25, 25, 26,  0, 27],  //K?
  [ 0,  0, 17, 17, 18, 18, 18, 19, 19, 20,  0, 21, 22]   //Q?
];

var two_pair_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
  [ 0, 37, 37, 39, 41, 43, 46, 49, 54, 58, 62, 64, 64],
  [ 0,  3,  3,  4,  4,  5,  7,  8, 10, 11, 13, 14, 14]
];

var triple_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [99, 99, 99, 99, 99,100,100,100,100,100,100,100,100],
  [63, 66, 69, 71, 72, 72, 74, 74, 74, 75, 75, 75, 76],
  [12, 13, 13, 15, 16, 16, 16, 16, 16, 14, 15, 15, 15]
];

var straight_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
  [ 0,  0,  0, 77, 79, 81, 83, 85, 87, 88, 89, 91, 92],
  [ 0,  0,  0, 16, 18, 20, 22, 24, 26, 28, 31, 34, 37]
];

var flush_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
  [ 0,  0,  0,  0,  0, 93, 92, 92, 93, 94, 95, 97, 98],
  [ 0,  0,  0,  0,  0, 35, 37, 38, 38, 40, 44, 50, 61]
];

var flush_value2 = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0, 53, 54, 55, 56, 57, 59, 62, 65,  0],  //A?
  [ 0,  0,  0, 44, 44, 45, 46, 47, 48, 49, 52,  0,  0],  //K?
  [ 0,  0,  0, 41, 41, 41, 42, 42, 44, 45,  0,  0,  0]   //Q?
];

var full_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
  [98, 99, 99, 99, 99, 99, 99, 99,100,100,100,100,100],
  [65, 66, 69, 71, 73, 75, 78, 80, 82, 85, 88, 91, 94],
];

var quadruple_value = [
  //2   3   4   5   6   7   8   9   T   J   Q   K   A
  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
  [100,100,100,100,100,100,100,100,100,100,100,100,100],
  [ 94, 94, 95, 95, 95, 96, 97, 97, 97, 97, 98, 98, 98]
];

class WaveEvaluator {
  constructor(cards, order) {
    this.cards = cards.slice(0);
    this.order = order;

    this.features = [];
    this.extract_features();
    this.win_percent = this.evaluate();
  }

  extract_features() {
    this.cards.sort(function(a, b) { return rank(a) - rank(b); });

    var num_junks = 0, num_pairs = 0, num_triples = 0;
    var length = this.cards.length;
    for (var i = 0; i < length; ++i) {
      var r = rank(this.cards[i]);
      if (i + 1 >= length || r != rank(this.cards[i + 1])) {
        this.features.push({type: Junk, rank: r});
        ++num_junks;
      } else if (i + 2 >= length || r != rank(this.cards[i + 2])) {
        this.features.push({type: Pair, rank: r});
        ++num_pairs;
        i += 1;
      } else if (i + 3 >= length || r != rank(this.cards[i + 3])) {
        this.features.push({type: Triple, rank: r});
        ++num_triples;
        i += 2;
      } else {
        this.features.push({type: Quadruple, rank: r});
        i += 3;
      }
    }
    if (num_junks == 5) {
      var high_rank = rank(this.cards[4]);
      var straight = false;
      if (rank(this.cards[0]) + 4 == rank(this.cards[4])) {
        straight = true;
      }
      // Special case for 2345A.
      if (rank(this.cards[0]) == Two && rank(this.cards[3]) == Five &&
          rank(this.cards[4]) == Ace) {
        straight = true;
        high_rank = Five;
      }

      var flush = true;
      for (var i = 0; i < length - 1; ++i) {
        if (suit(this.cards[i]) != suit(this.cards[i + 1])) {
          flush = false;
          break;
        }
      }

      if (straight && flush) {
        var type = high_rank == Ace ? RoyalFlush : StraightFlush;
        this.features = [{type: type, rank: high_rank}];
      } else if (straight) {
        this.features = [{type: Straight, rank: high_rank}];
      } else if (flush) {
        this.features.pop();
        this.features.push({type: Flush, rank: high_rank});
      }
    }

    this.features.sort(function(a, b) {
      return a.type == b.type ? b.rank - a.rank : b.type - a.type;
    });

    if (num_pairs == 2) {
      this.features[0].type = TwoPairs;
    }
    if (num_triples == 1 && num_pairs == 1) {
      this.features[0].type = FullHouse;
    }
  }

  evaluate() {
    var r0 = this.rank;
    switch (this.pattern) {
      case RoyalFlush:
        return 100;
      case StraightFlush:
        return 100;
      case Quadruple:
        return quadruple_value[this.order][r0];
      case FullHouse:
        return full_value[this.order][r0];
      case Flush:
        var r1 = this.features[1].rank;
        if (this.order == Back && r0 >= Queen)
          return flush_value2[Ace - r0][r1];
        return flush_value[this.order][r0];
      case Straight:
        return straight_value[this.order][r0];
      case Triple:
        return triple_value[this.order][r0];
      case TwoPairs:
        return two_pair_value[this.order][r0];
      case Pair:
        var r1 = this.features[1].rank;
        if (this.order == Front && r0 >= Queen)
          return one_pair_value0[Ace - r0][r1];
        if (this.order == Center && r0 >= Queen)
          return one_pair_value1[Ace - r0][r1];
        return one_pair_value[this.order][r0];
      case Junk:
        var r1 = this.features[1].rank;
        if (this.order == Front && r0 >= Queen)
          return junk_value0[Ace - r0][r1];
        return junk_value[this.order][r0];
    }
  }

  get pattern() { return this.features[0].type; }
  get rank() { return this.features[0].rank; }
  get value() { return this.win_percent; }
  get wave() {
    // Special case for 2345A.
    if (this.pattern == Straight && this.rank == Five)
      return this.cards.slice(4, 5).concat(this.cards.slice(0, 4));
    return this.cards;
  }

  is_smaller_than(wave) {
    var min_features = Math.min(this.features.length, wave.features.length);
    for (var i = 0; i < min_features; ++i) {
      if (this.features[i].type < wave.features[i].type) return true;
      if (this.features[i].type > wave.features[i].type) return false;
      if (this.features[i].rank < wave.features[i].rank) return true;
      if (this.features[i].rank > wave.features[i].rank) return false;
    }
    return false;
  }
};

class HandOptimizer {
  constructor(hand, handicap = 0) {
    this.hand = hand.slice(0);

    this.all_waves = [];
    this.optimize_waves();

    var index = Math.max(this.all_waves.length - 1 - handicap, 0);
    this.max_waves = this.all_waves[index];
  }

  optimize_waves() {
    this.hand.sort(function(a, b) { return rank(a) - rank(b); });
    this.max_value = 0;
    this.optimize_back();
  }

  optimize_back() {
    for (var b1 = 0; b1 < 9; ++b1) {
      for (var b2 = b1 + 1; b2 < 10; ++b2) {
        for (var b3 = b2 + 1; b3 < 11; ++b3) {
          for (var b4 = b3 + 1; b4 < 12; ++b4) {
            for (var b5 = b4 + 1; b5 < 13; ++b5) {
              this.back = new WaveEvaluator(
                [this.hand[b1], this.hand[b2], this.hand[b3],
                 this.hand[b4], this.hand[b5]], Back);
              if (this.back.pattern == Junk) continue;
              if (200 + this.back.value < this.max_value) continue;

              var bits = (1<<b1) + (1<<b2) + (1<<b3) + (1<<b4) + (1<<b5);
              this.optimize_center(bits);
            }
          }
        }
      }
    }
  }

  optimize_center(bits) {
    out:
    for (var c1 = 0; c1 < 9; ++c1) {
      if ((1 << c1) & bits) continue;
      for (var c2 = c1 + 1; c2 < 10; ++c2) {
        if ((1 << c2) & bits) continue;
        for (var c3 = c2 + 1; c3 < 11; ++c3) {
          if ((1 << c3) & bits) continue;
          for (var c4 = c3 + 1; c4 < 12; ++c4) {
            if ((1 << c4) & bits) continue;
            for (var c5 = c4 + 1; c5 < 13; ++c5) {
              if ((1 << c5) & bits) continue;

              this.center = new WaveEvaluator(
                [this.hand[c1], this.hand[c2], this.hand[c3],
                 this.hand[c4], this.hand[c5]], Center);
              if (this.back.is_smaller_than(this.center)) break out;
              if (100 + this.center.value + this.back.value < this.max_value)
                continue;

              var center_bits = (1<<c1) + (1<<c2) + (1<<c3) + (1<<c4) + (1<<c5);
              this.optimize_front(bits + center_bits);
            }
          }
        }
      }
    }
  }

  optimize_front(bits) {
    out:
    for (var f1 = 0; f1 < 11; ++f1) {
      if ((1 << f1) & bits) continue;
      for (var f2 = f1 + 1; f2 < 12; ++f2) {
        if ((1 << f2) & bits) continue;
        for (var f3 = f2 + 1; f3 < 13; ++f3) {
          if ((1 << f3) & bits) continue;

          this.front = new WaveEvaluator(
            [this.hand[f1], this.hand[f2], this.hand[f3]], Front);
          if (this.center.is_smaller_than(this.front)) break out;

          var sum_value = this.front.value + this.center.value + this.back.value;
          if (this.max_value < sum_value) {
            this.max_value = sum_value;
            this.all_waves.push([].concat(this.front.wave, this.center.wave,
                                          this.back.wave));
          }
        }
      }
    }
  }

  get waves() {
    return [this.max_waves.slice(0, 3),
            this.max_waves.slice(3, 8),
            this.max_waves.slice(8, 13)];
  }
};

function optimize_hand() {
  waves = (new HandOptimizer(hand)).waves;
  for (var wave in waves) {
    for (var card in waves[wave]) {
      membership[waves[wave][card]] = wave;
    }
    redraw_wave(wave);
  }
  redraw_hand();
}
    </script>
  </head>
  <body onload='deal_hand()'>
    <h1>Chinese Poker</h1>
    <table class='table'>
      <tr>
        <td>
          <table class='hand' id='ai_front'>
            <tr>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_front_rank_0'>?</td></tr>
                  <tr><td class='suit' id='ai_front_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_front_rank_1'>?</td></tr>
                  <tr><td class='suit' id='ai_front_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_front_rank_2'>?</td></tr>
                  <tr><td class='suit' id='ai_front_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table class='hand' id='ai_center'>
            <tr>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_center_rank_0'>?</td></tr>
                  <tr><td class='suit' id='ai_center_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_center_rank_1'>?</td></tr>
                  <tr><td class='suit' id='ai_center_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_center_rank_2'>?</td></tr>
                  <tr><td class='suit' id='ai_center_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_center_rank_3'>?</td></tr>
                  <tr><td class='suit' id='ai_center_suit_3'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_center_rank_4'>?</td></tr>
                  <tr><td class='suit' id='ai_center_suit_4'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table class='hand' id='ai_back'>
            <tr>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_back_rank_0'>?</td></tr>
                  <tr><td class='suit' id='ai_back_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_back_rank_1'>?</td></tr>
                  <tr><td class='suit' id='ai_back_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_back_rank_2'>?</td></tr>
                  <tr><td class='suit' id='ai_back_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_back_rank_3'>?</td></tr>
                  <tr><td class='suit' id='ai_back_suit_3'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card'>
                  <tr><td class='rank' id='ai_back_rank_4'>?</td></tr>
                  <tr><td class='suit' id='ai_back_suit_4'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td class='menu'>
          <b>Level</b><br/>
          <select class='menu' id='handicap' onchange='select_level()'>
            <option value='3'>Jack</option>
            <option value='2'>Queen</option>
            <option value='1' selected>King</option>
            <option value='0'>Ace</option>
          </select>
        </td>
      </tr>
      <tr class='menu'>
        <td><div class='logo' id='logo'>十三水</div></td>
        <td><div class='score' id='score'>You 0-0 AI</div></td>
        <td>
          <button class='menu' id='save' onclick='save_waves()'>Save</button>
          <b class='menu' id='load'></b>
        </td>
        <td>
          <button class='menu' id='deal' onclick='deal_hand()'>Deal</button>
          <button class='menu' id='show' onclick='show_hand()'>Show</button>
        </td>
      </tr>
      <tr class='pattern'>
        <td id='front_pattern'></td>
        <td id='center_pattern'></td>
        <td id='back_pattern'></td>
        <td id='average'></td>
      </tr>
      <tr>
        <td>
          <table class='hand' id='front'>
            <tr>
              <td>
                <table class='card' onclick='undo_card(Front, 0)'>
                  <tr><td class='rank' id='front_rank_0'>?</td></tr>
                  <tr><td class='suit' id='front_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Front, 1)'>
                  <tr><td class='rank' id='front_rank_1'>?</td></tr>
                  <tr><td class='suit' id='front_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Front, 2)'>
                  <tr><td class='rank' id='front_rank_2'>?</td></tr>
                  <tr><td class='suit' id='front_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table class='hand' id='center'>
            <tr>
              <td>
                <table class='card' onclick='undo_card(Center, 0)'>
                  <tr><td class='rank' id='center_rank_0'>?</td></tr>
                  <tr><td class='suit' id='center_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Center, 1)'>
                  <tr><td class='rank' id='center_rank_1'>?</td></tr>
                  <tr><td class='suit' id='center_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Center, 2)'>
                  <tr><td class='rank' id='center_rank_2'>?</td></tr>
                  <tr><td class='suit' id='center_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Center, 3)'>
                  <tr><td class='rank' id='center_rank_3'>?</td></tr>
                  <tr><td class='suit' id='center_suit_3'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Center, 4)'>
                  <tr><td class='rank' id='center_rank_4'>?</td></tr>
                  <tr><td class='suit' id='center_suit_4'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table class='hand' id='back'>
            <tr>
              <td>
                <table class='card' onclick='undo_card(Back, 0)'>
                  <tr><td class='rank' id='back_rank_0'>?</td></tr>
                  <tr><td class='suit' id='back_suit_0'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Back, 1)'>
                  <tr><td class='rank' id='back_rank_1'>?</td></tr>
                  <tr><td class='suit' id='back_suit_1'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Back, 2)'>
                  <tr><td class='rank' id='back_rank_2'>?</td></tr>
                  <tr><td class='suit' id='back_suit_2'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Back, 3)'>
                  <tr><td class='rank' id='back_rank_3'>?</td></tr>
                  <tr><td class='suit' id='back_suit_3'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' onclick='undo_card(Back, 4)'>
                  <tr><td class='rank' id='back_rank_4'>?</td></tr>
                  <tr><td class='suit' id='back_suit_4'>?</td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table>
            <tr>
              <td>
              <button class='menu' onclick='optimize_hand()'>Auto</button>
              </td>
            </tr>
            <tr>
            </tr>
            <tr>
              <td>
                <button class='menu' onclick='undo_all_cards()'>Clear</button>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <tr class='move'>
        <td>
          <button class='move' onclick='fill_wave(Front)'>⇈</button>
          &nbsp; &nbsp;
          <button class='move' onclick='clear_wave(Front)'>⇊</button>
        </td>
        <td>
          <button class='move' onclick='fill_wave(Center)'>⇈</button>
          &nbsp; &nbsp;
          <button class='move' onclick='clear_wave(Center)'>⇊</button>
        </td>
        <td>
          <button class='move' onclick='fill_wave(Back)'>⇈</button>
          &nbsp; &nbsp;
          <button class='move' onclick='clear_wave(Back)'>⇊</button>
        </td>
      </tr>
      <tr>
        <td colspan='3'>
          <div class='special' id='special'></div>
          <table class='hand'>
            <tr>
              <td>
                <table class='card' id='card_0' onclick='move_card(0)'>
                  <tr><td class='rank' id='rank_0'></td></tr>
                  <tr><td class='suit' id='suit_0'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_1' onclick='move_card(1)'>
                  <tr><td class='rank' id='rank_1'></td></tr>
                  <tr><td class='suit' id='suit_1'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_2' onclick='move_card(2)'>
                  <tr><td class='rank' id='rank_2'></td></tr>
                  <tr><td class='suit' id='suit_2'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_3' onclick='move_card(3)'>
                  <tr><td class='rank' id='rank_3'></td></tr>
                  <tr><td class='suit' id='suit_3'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_4' onclick='move_card(4)'>
                  <tr><td class='rank' id='rank_4'></td></tr>
                  <tr><td class='suit' id='suit_4'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_5' onclick='move_card(5)'>
                  <tr><td class='rank' id='rank_5'></td></tr>
                  <tr><td class='suit' id='suit_5'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_6' onclick='move_card(6)'>
                  <tr><td class='rank' id='rank_6'></td></tr>
                  <tr><td class='suit' id='suit_6'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_7' onclick='move_card(7)'>
                  <tr><td class='rank' id='rank_7'></td></tr>
                  <tr><td class='suit' id='suit_7'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_8' onclick='move_card(8)'>
                  <tr><td class='rank' id='rank_8'></td></tr>
                  <tr><td class='suit' id='suit_8'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_9' onclick='move_card(9)'>
                  <tr><td class='rank' id='rank_9'></td></tr>
                  <tr><td class='suit' id='suit_9'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_10' onclick='move_card(10)'>
                  <tr><td class='rank' id='rank_10'></td></tr>
                  <tr><td class='suit' id='suit_10'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_11' onclick='move_card(11)'>
                  <tr><td class='rank' id='rank_11'></td></tr>
                  <tr><td class='suit' id='suit_11'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
              <td>
                <table class='card' id='card_12' onclick='move_card(12)'>
                  <tr><td class='rank' id='rank_12'></td></tr>
                  <tr><td class='suit' id='suit_12'></td></tr>
                  <tr><td></td></tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <table>
            <tr>
              <td>
                <button class='menu' id='sort' onclick='sort_hand(true)'>Sort</button>
              </td>
            </tr>
            <tr></tr>
            <tr>
              <td>
                <button class='menu' id='claim' onclick='claim()'>Claim</button>
              </td>
            </tr>
          </table>
          <div class='alert' id='alert' onclick='hide_element("alert")'>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p id='alert_message'></p>
            <button class='menu' onclick='hide_element("alert")'>OK</button>
          </div>
        </td>
      </tr>
    </table>
  </body>
</html>
